# Story 4.5: State Management - Cookies → URL Hash

## Epic
Epic 4: Design & UI Refresh

## User Story

Jako uživatel
Chci, aby nastavení hry (Překážky ano/ne) bylo uloženo v URL
Abych mohl sdílet odkaz se stejným nastavením a aby se aplikace lépe škálovala

## Description

Změnit persistence stavu hry z cookies na URL hash. Místo ukládání do cookies budeme používat fragment identifikátor URL (za `#`).

Příklad:
- `https://example.com/` - bez překážek (default)
- `https://example.com/#obstacles=yes` - s překážkami

**Důvod:** Cookies nejsou škálovatelné pro více nastavení. URL je lepší pro sdílení a budoucí rozšíření.

## Tasks

- [ ] Vytvořit story dokument
- [ ] Vytvořit funkce pro čtení/zápis URL hash
- [ ] Adaptovat `restoreObstaclesFromCookie()` → `restoreObstaclesFromURL()`
- [ ] Adaptovat event listener na select pro zápis URL
- [ ] Odebrat cookie logiku (nebo ponechat jako fallback)
- [ ] Aktualizovat testy
- [ ] Testovat URL hash persistence

## Acceptance Criteria

1. **AC1:** Stav překážek je uložen v URL hash (np. `#obstacles=yes`)
2. **AC2:** Při načtení stránky se select nastaví podle URL
3. **AC3:** Změna selectu aktualizuje URL
4. **AC4:** URL změna se odráží v DOM (back button funguje)
5. **AC5:** Výchozí stav je `#obstacles=no` nebo bez fragmentu
6. **AC6:** Cookies logika je odstraněna (nebo ignorována)
7. **AC7:** Všechny testy procházejí
8. **AC8:** Build je úspěšný

## Test Plan

### Visual Testing
- [ ] Otevřít aplikaci - URL bez fragmentu
- [ ] Vybrat "S překážkami" - URL se změní na `#obstacles=yes`
- [ ] Obnovit stránku - select je stále na "S překážkami"
- [ ] Kliknutí zpět - URL se změní na `#obstacles=no`
- [ ] Ručně napsat URL s `#obstacles=yes` - select se nastaví

### Automated Testing
- [ ] Všechny testy procházejí (111/111)
- [ ] Build je bez chyb

## Files Changed

### Modified Files
- `src/game.js` - Nahradit cookie logiku URL hash logikou
- `src/game.integration.test.js` - Aktualizovat testy

## Technical Notes

### URL Hash Format
```
https://piskvorky.polyweb.cz/#obstacles=yes
```

### Implementation Approach

1. **Čtení hash:** `window.location.hash` → parse pro `obstacles=yes|no`
2. **Zápis hash:** `window.history.replaceState()` nebo `window.location.hash = '...'`
3. **Event:** `hashchange` event pro sluchání změn

### Code Structure

```javascript
// Čtení z URL
getObstaclesFromHash() {
  const hash = window.location.hash.slice(1); // Odebrat #
  const params = new URLSearchParams(hash);
  return params.get('obstacles') === 'yes';
}

// Zápis do URL
setObstaclesHash(enabled) {
  const hash = enabled ? 'obstacles=yes' : 'obstacles=no';
  window.location.hash = hash;
}

// Poslouchání změn
window.addEventListener('hashchange', () => {
  const enabled = this.getObstaclesFromHash();
  this.obstaclesSelect.value = enabled ? 'yes' : 'no';
  // Re-init game...
});
```

### Fallback
- Pokud je URL bez fragmentu → výchozí "Bez překážek"
- Neznámé hodnoty v URL → ignorovat

## Risk Assessment

**Risk 1:** Hash změny mohou prověřit game state
- **Mitigation:** Hashchange event resetu hru (stejně jako select změna)

**Risk 2:** Staré cookies mohou kolidovat
- **Mitigation:** URL hash má prioritu, cookies jsou ignorovány

## Definition of Done

- [ ] Story dokument napsán
- [ ] URL hash logika implementována
- [ ] Všechny references na cookies odstraněny/ignorovány
- [ ] Testy aktualizovány a procházejí
- [ ] Visual testing completed
- [ ] Build úspěšný ✓
- [ ] URL sharing works (lze poslat odkaz s nastavením)
- [ ] Commit vytvořen

## Status

Draft → In Progress → Completed

---

**Created:** 2025-11-02
**Epic:** 4 - Design & UI Refresh
**Priority:** High
**Effort:** M (45-60 minutes)
**Depends on:** 4.4 ✓
**Follow-up:** Připrava na více parametrů (např. AI opponent, difficulty)

## Implementation Notes

### Migration from Cookies to URL Hash

**Old (Cookie-based):**
```javascript
restoreObstaclesFromCookie() {
  const cookieValue = this.getCookie('obstaclesEnabled');
  if (cookieValue === 'true') {
    this.obstaclesCheckbox.checked = true;
    // generate obstacles
  }
}

attachEventListeners() {
  this.obstaclesCheckbox.addEventListener('change', (e) => {
    this.setCookie('obstaclesEnabled', e.target.checked ? 'true' : 'false');
  });
}
```

**New (URL Hash):**
```javascript
getObstaclesFromHash() {
  try {
    const hash = window.location.hash.slice(1);
    const params = new URLSearchParams(hash);
    return params.get('obstacles') === 'yes';
  } catch {
    return false; // Default: Bez překážek
  }
}

setObstaclesHash(enabled) {
  const newHash = enabled ? '#obstacles=yes' : '';
  if (window.location.hash !== newHash) {
    window.location.hash = newHash;
  }
}

restoreObstaclesFromURL() {
  const enabled = this.getObstaclesFromHash();
  this.obstaclesSelect.value = enabled ? 'yes' : 'no';

  if (enabled) {
    const obstacles = generateRandomObstacles(15, this.game.size);
    this.game.setObstacles(obstacles);
  }
}

attachEventListeners() {
  // Select change - aktualizuj URL
  this.obstaclesSelect.addEventListener('change', (e) => {
    const enabled = e.target.value === 'yes';
    this.setObstaclesHash(enabled);
    // Reset game...
  });

  // Poslouchej URL změny (back/forward button)
  window.addEventListener('hashchange', () => {
    const enabled = this.getObstaclesFromHash();
    this.obstaclesSelect.value = enabled ? 'yes' : 'no';
    // Reset game...
  });
}
```

Výhody URL hash:
- ✓ Shareable links (lze poslat kamarádům s nastavením)
- ✓ Back/forward button funguje
- ✓ Snadné rozšíření na více parametrů
- ✓ Není potřeba server-side tracking
- ✓ GDPR friendly (žádné cookies)
